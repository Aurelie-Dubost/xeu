import pandas as pd
from dateutil.easter import easter

def eurex_derivatives_closed_days(year: int) -> set[pd.Timestamp]:
    # Eurex derivatives closures (core “all derivatives” set incl. 24 Dec + 31 Dec trading closures)
    e = easter(year)
    closed = {
        pd.Timestamp(year, 1, 1),                 # New Year
        pd.Timestamp(e) - pd.Timedelta(days=2),   # Good Friday
        pd.Timestamp(e) + pd.Timedelta(days=1),   # Easter Monday
        pd.Timestamp(year, 5, 1),                 # May 1
        pd.Timestamp(year, 12, 24),               # closed for trading
        pd.Timestamp(year, 12, 25),               # closed
        pd.Timestamp(year, 12, 26),               # closed
        pd.Timestamp(year, 12, 31),               # closed for trading
    }
    return closed

def sx5e_past_weeklies_rule_based(start="2018-01-01", end=None):
    end = pd.Timestamp(end or pd.Timestamp.today()).normalize()
    fridays = pd.date_range(start, end, freq="W-FRI")
    weeklies = fridays[~fridays.day.between(15, 21)]
    weeklies = weeklies[weeklies < pd.Timestamp.today().normalize()]

    out = []
    for d in weeklies:
        x = pd.Timestamp(d).normalize()
        closed = eurex_derivatives_closed_days(x.year)

        # roll back through weekends + closed days (this yields Tue 23 when 24/25/26 are closed)
        while x.weekday() >= 5 or x in closed:
            x -= pd.Timedelta(days=1)
        out.append(x)

    return sorted(pd.DatetimeIndex(out).unique().date)

print(sx5e_past_weeklies_rule_based("2025-12-01", "2025-12-31"))